# ═════════════════════════════════════════════════════════════════════════════
# Kong API Gateway Declarative Configuration
# ═══════════════════════════════════════════════════════════════════════════════

_format_version: "3.0"

# ────────────────────────────────────────────────────────────────────────────────
# Services
# ────────────────────────────────────────────────────────────────────────────────

services:
  # Auth Service
  - name: auth-service
    url: http://auth-service:8001
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # User Service
  - name: user-service
    url: http://user-service:8002
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Order Service
  - name: order-service
    url: http://order-service:8003
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Payment Service
  - name: payment-service
    url: http://payment-service:8004
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

  # Notification Service
  - name: notification-service
    url: http://notification-service:8005
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3

# ────────────────────────────────────────────────────────────────────────────────
# Routes
# ────────────────────────────────────────────────────────────────────────────────

routes:
  # Auth Routes
  - name: auth-routes
    service: auth-service
    paths:
      - /v1/auth
      - /v1/auth/login
      - /v1/auth/register
      - /v1/auth/refresh
      - /v1/auth/logout
      - /v1/auth/forgot-password
    methods:
      - POST
      - PUT
      - GET
    strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: redis
          redis_host: redis
          redis_port: 6379
          fault_tolerant: true

  # User Routes (Authenticated)
  - name: user-routes
    service: user-service
    paths:
      - /v1/users
    methods:
      - GET
      - POST
      - PUT
      - DELETE
    strip_path: false
    plugins:
      - name: jwt
        config:
          uri_param_names:
            - jwt
          claims_to_verify:
            - exp
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
          policy: redis
          redis_host: redis
          redis_port: 6379
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          max_age: 3600
          exposed_headers:
            - X-Total-Count
            - X-Page-Token

  # Order Routes (Authenticated)
  - name: order-routes
    service: order-service
    paths:
      - /v1/orders
      - /v1/orders/(?P<order_id>[^/]+)
    methods:
      - GET
      - POST
      - PUT
      - DELETE
    strip_path: false
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 50
          hour: 500
          policy: redis
          redis_host: redis
          redis_port: 6379
      - name: request-transformer
        config:
          add:
            headers:
              - X-Service-Id:order-service

  # Payment Routes (Strict Auth)
  - name: payment-routes
    service: payment-service
    paths:
      - /v1/payments
      - /v1/payments/(?P<payment_id>[^/]+)
    methods:
      - POST
      - GET
    strip_path: false
    plugins:
      - name: jwt
      - name: acl
        config:
          allow:
            - admin
            - payment-processor
      - name: rate-limiting
        config:
          minute: 10
          hour: 100
          policy: redis
          redis_host: redis
          redis_port: 6379
      - name: request-size-limiting
        config:
          allowed_payload_size: 128

# ────────────────────────────────────────────────────────────────────────────────
# Plugins (Global)
# ────────────────────────────────────────────────────────────────────────────────

plugins:
  # Global rate limiting
  - name: rate-limiting
    enabled: false
    config:
      minute: 60
      hour: 1000
      policy: local
      fault_tolerant: true

  # CORS for all routes
  - name: cors
    enabled: true
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
      max_age: 3600
      exposed_headers:
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset

  # StatsD metrics
  - name: statsd
    enabled: true
    config:
      host: statsd
      port: 8125

  # Prometheus metrics
  - name: prometheus
    enabled: true

# ────────────────────────────────────────────────────────────────────────────────
# Consumers
# ────────────────────────────────────────────────────────────────────────────────

consumers:
  - username: admin
    custom_id: admin_001
    tags:
      - admin
      - system

  # Service accounts for inter-service communication
  - username: order-service
    custom_id: service_order
    tags:
      - service

  - username: notification-service
    custom_id: service_notification
    tags:
      - service

# ────────────────────────────────────────────────────────────────────────────────
# JWT Credentials
# ────────────────────────────────────────────────────────────────────────────────

jwt_secrets:
  - consumer: admin
    key: admin_key
    secret: admin_secret_change_me
    algorithm: HS256

  - consumer: order-service
    key: order_service_key
    secret: order_service_secret_change_me
    algorithm: HS256

  - consumer: notification-service
    key: notification_service_key
    secret: notification_service_secret_change_me
    algorithm: HS256

# ────────────────────────────────────────────────────────────────────────────────
# ACL Groups
# ────────────────────────────────────────────────────────────────────────────────

acls:
  - consumer: admin
    group: admin

  - consumer: order-service
    group: payment-processor

  - consumer: notification-service
    group: notification-service

# ────────────────────────────────────────────────────────────────────────────────
# Upstreams (for advanced load balancing)
# ────────────────────────────────────────────────────────────────────────────────

upstreams:
  - name: user-service-upstream
    algorithm: least-connections
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
      passive:
        type: http
        healthy:
          http_statuses:
            - 200
            - 201
          successes: 2
        unhealthy:
          http_failures: 3
