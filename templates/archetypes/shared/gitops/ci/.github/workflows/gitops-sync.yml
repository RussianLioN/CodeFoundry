# GitOps Sync Workflow
# Automatically updates image tags in Git after successful deployment
# This enables ArgoCD to sync the new images automatically

name: GitOps Sync

on:
  push:
    branches:
    - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: commit SHA)'
        required: false
        default: ''

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.event.repository.name }}

jobs:
  sync-image:
    name: Update Image Tag in Git
    runs-on: ubuntu-latest
    # Only run after successful CI/CD
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine image tag
        id: image-tag
        run: |
          # Use input tag if provided, otherwise use commit SHA
          if [ -n "${{ inputs.image_tag }}" ]; then
            TAG="${{ inputs.image_tag }}"
          else
            TAG="${{ github.sha }}"
          fi

          # For GitHub Container Registry, use full SHA
          if echo "$TAG" | grep -qE "^[a-f0-9]{40}$"; then
            IMAGE_TAG="$TAG"
          else
            IMAGE_TAG="$TAG"
          fi

          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "üì¶ Using image tag: $IMAGE_TAG"

      - name: Find archetype directories
        id: find-archetypes
        run: |
          # Find all archetype directories with k8s/overlays/production
          ARCHETYPES=$(find templates/archetypes -type d -name "production" | grep "k8s/overlays/production" | sed 's|/k8s/overlays/production||')

          # Filter archetypes that actually exist for this repo
          EXISTING_ARCHETYPES=""
          for archetype in $ARCHETYPES; do
            if [ -d "$archetype" ]; then
              EXISTING_ARCHETYPES="$EXISTING_ARCHETYPES $archetype"
            fi
          done

          echo "archetypes=$EXISTING_ARCHETYPES" >> $GITHUB_OUTPUT
          echo "üìÅ Found archetypes: $EXISTING_ARCHETYPES"

      - name: Update image tags in kustomize files
        env:
          IMAGE_TAG: ${{ steps.image-tag.outputs.image_tag }}
        run: |
          ARCHETYPES="${{ steps.find-archetypes.outputs.archetypes }}"

          for archetype in $ARCHETYPES; do
            echo "üîÑ Processing $archetype..."

            KUSTOMIZE_FILE="$archetype/k8s/overlays/production/kustomization.yaml"

            if [ ! -f "$KUSTOMIZE_FILE" ]; then
              echo "‚ö†Ô∏è  Skipping $archetype (no kustomization.yaml found)"
              continue
            fi

            # Backup original file
            cp "$KUSTOMIZE_FILE" "$KUSTOMIZE_FILE.bak"

            # Update image tag using kustomize edit
            if kustomize edit set image \
              --name "${IMAGE_NAME}" \
              --tag "${IMAGE_TAG}" \
              "$KUSTOMIZE_FILE"; then
              echo "‚úÖ Updated $KUSTOMIZE_FILE"
            else
              echo "‚ö†Ô∏è  No image found in $KUSTOMIZE_FILE, skipping..."
              rm -f "$KUSTOMIZE_FILE.bak"
              continue
            fi

            # Show the diff
            git diff "$KUSTOMIZE_FILE" || true

            # Remove backup if successful
            rm -f "$KUSTOMIZE_FILE.bak"
          done

      - name: Commit and push changes
        run: |
          # Check if there are any changes
          if git diff --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
            exit 0
          fi

          # Create commit
          git add -A
          git commit -m "chore(gitops): update image tag to ${{ steps.image-tag.outputs.image_tag }}

          This commit was automatically created by the GitOps Sync workflow.
          Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.image_tag }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          "

          # Push changes
          git push

      - name: Trigger ArgoCD sync
        if: success()
        run: |
          echo "üîÑ Triggering ArgoCD sync..."
          echo "ArgoCD will automatically detect the Git changes and sync applications."
          echo ""
          echo "To manually sync, run:"
          echo "  argocd app sync <application-name>"
          echo ""
          echo "To watch sync progress:"
          echo "  argocd app watch <application-name>"

  # Optional: Rollback on failure
  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: sync-image
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rollback image tag changes
        run: |
          echo "‚ö†Ô∏è  Deployment failed, rolling back GitOps changes..."

          # Reset last commit
          git reset --hard HEAD~1

          # Force push
          git push --force

          echo "‚úÖ Rollback complete. Please investigate the deployment failure."
