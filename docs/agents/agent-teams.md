# Agent Teams и Субагенты в Claude Code — Полное Руководство

> [Главная](../../README.md) → [Документация](../INDEX.md) → [Агенты](index.md) → **Agent Teams**

---

**Version:** 2.0.0
**Last Updated:** 2026-02-09
**Claude Code:** 2.1.16+ (текущая: 2.1.37)
**Model:** Opus 4.6 (координатор), Sonnet/Haiku (субагенты)

---

## Содержание

- [Как работают субагенты](#как-работают-субагенты)
- [Конфигурация CodeFoundry](#конфигурация-codefoundry)
- [Task Tool — запуск субагентов](#task-tool--запуск-субагентов)
- [Типы субагентов](#типы-субагентов)
- [Модели и стоимость](#модели-и-стоимость)
- [Практические сценарии](#практические-сценарии)
- [Лучшие практики](#лучшие-практики)
- [Траблшутинг](#траблшутинг)

---

## Как работают субагенты

**Agent Teams** — встроенная возможность Claude Code. Главный агент (Opus 4.6) выступает координатором и запускает субагентов через **Task tool** для параллельной работы.

```
Пользователь
     ↓
Главный агент (Opus 4.6) — координатор
     ↓ Task tool
     ├── Субагент 1 (Sonnet) — задача A
     ├── Субагент 2 (Haiku)  — задача B
     └── Субагент 3 (Sonnet) — задача C
     ↓
Главный агент собирает результаты → ответ пользователю
```

**Ключевой принцип:** Отдельный "координатор-агент" НЕ нужен. Главный Claude IS the coordinator.

---

## Конфигурация CodeFoundry

### settings.json (актуальная)

```json
{
  "env": {
    "CLAUDE_CODE_SUBAGENT_MODEL": "sonnet"
  }
}
```

Эта переменная задаёт модель по умолчанию для ВСЕХ субагентов. Каждый агент может переопределить её через `model:` в своём frontmatter.

### Per-agent модели

Задаются в frontmatter файла `.claude/agents/{name}.md`:

```yaml
---
name: my-agent
model: haiku      # haiku | sonnet | opus | inherit
tools: [Read, Grep, Glob, Bash]
---
```

### Текущая конфигурация агентов

| Агент | Модель | Задачи |
|-------|--------|--------|
| **token-optimizer** | haiku | Подсчёт токенов, аудит файлов |
| **tasks-sync** | haiku | Синхронизация TASKS.md → GitHub |
| **documentation-agent** | haiku | Валидация доков, @ref проверки |
| **ollama-gemini-researcher** | sonnet | Исследование, web search |

### Переменные окружения

```bash
CLAUDE_CODE_SUBAGENT_MODEL=sonnet   # Модель субагентов по умолчанию
CLAUDE_LOG=debug                     # Debug режим (опционально)
```

---

## Task Tool — запуск субагентов

Task tool — это основной механизм создания субагентов. Каждый вызов создаёт **изолированный** субпроцесс со своим контекстом.

### Параметры

| Параметр | Тип | Описание |
|----------|-----|----------|
| `prompt` | string | Задача для субагента (подробная!) |
| `subagent_type` | string | Тип агента (см. ниже) |
| `model` | enum | `haiku`, `sonnet`, `opus` (override) |
| `run_in_background` | bool | Запуск в фоне (параллельность) |
| `description` | string | Краткое описание (3-5 слов) |

### Пример: Параллельный запуск

Для параллельной работы нескольких агентов главный агент отправляет **несколько Task вызовов в одном сообщении**:

```
Сообщение от главного агента:
  Task 1: { subagent_type: "Explore", prompt: "Найди все TODO в src/", run_in_background: true }
  Task 2: { subagent_type: "Explore", prompt: "Найди все FIXME в tests/", run_in_background: true }
  Task 3: { subagent_type: "Bash", prompt: "Запусти make test" }
```

Агенты 1 и 2 работают параллельно в фоне, агент 3 — синхронно.

---

## Типы субагентов

### Встроенные (всегда доступны)

| Тип | Когда использовать | Инструменты |
|-----|-------------------|-------------|
| **Explore** | Поиск файлов, исследование кодовой базы | Read, Grep, Glob |
| **Plan** | Планирование реализации | Read, Grep, Glob |
| **Bash** | Выполнение команд | Bash |
| **general-purpose** | Многоэтапные задачи, исследования | Все |

### Кастомные (`.claude/agents/`)

| Тип | Когда использовать | Модель |
|-----|-------------------|--------|
| **token-optimizer** | `cf-optimize`, аудит токенов | haiku |
| **tasks-sync** | Синхронизация с GitHub Issues | haiku |
| **documentation-agent** | `doc-check`, валидация доков | haiku |
| **ollama-gemini-researcher** | Исследование Ollama/Gemini | sonnet |

### Как Claude выбирает тип

1. **Автоматически** — по ключевым словам через `auto-routing-rules.json`
2. **Явно** — пользователь вызывает `/cf-optimize`, `make doc-check`
3. **Контекстно** — Claude сам решает, какой тип подходит для подзадачи

---

## Модели и стоимость

### Сравнение

| Модель | Стоимость (input/output) | Для чего |
|--------|------------------------|----------|
| **Opus 4.6** | $15 / $75 per Mtok | Координация, сложные задачи |
| **Sonnet 4.5** | $3 / $15 per Mtok | Исследования, анализ, web search |
| **Haiku 4.5** | $0.80 / $4 per Mtok | Файловые операции, подсчёт, валидация |

### Стратегия экономии

```
Главный агент: Opus 4.6 (координирует, общается с пользователем)
     ↓
Субагенты: Sonnet (по умолчанию, через env var)
     ↓
Лёгкие задачи: Haiku (через model: haiku в frontmatter)
```

**Экономия:** При 10 субагентах — с Opus на всех ($75 output) vs Haiku ($4 output) = **~95% экономия** на субагентах.

---

## Практические сценарии

### Сценарий 1: Параллельный Code Review

**Промпт:**
> "Проведи code review проекта. Каждый агент анализирует свою директорию."

**Что сделает Claude:**
```
Task 1 (Explore): "Проанализируй src/components/ на проблемы"    [background]
Task 2 (Explore): "Проанализируй src/utils/ на проблемы"         [background]
Task 3 (Explore): "Проанализируй src/services/ на проблемы"      [background]
→ Собрать результаты → Итоговый отчёт
```

### Сценарий 2: Documentation Health Check

**Промпт:**
> "Проверь документацию" или `make doc-check`

**Что сделает Claude:**
```
Task 1 (documentation-agent, haiku): "Validate all @ref links"
Task 2 (documentation-agent, haiku): "Check stale docs"
→ Отчёт с рекомендациями
```

### Сценарий 3: Token Optimization

**Промпт:**
> "Оптимизируй токены" или `/cf-optimize`

**Что сделает Claude:**
```
Task 1 (token-optimizer, haiku): "Audit CLAUDE.md and all @ref files"
→ Отчёт: per-file usage, рекомендации, estimated savings
```

### Сценарий 4: Исследование + Реализация

**Промпт:**
> "Исследуй как настроить Ollama с Gemini и создай docker-compose"

**Что сделает Claude:**
```
Task 1 (ollama-gemini-researcher, sonnet): "Исследуй Ollama + Gemini"  [background]
Task 2 (Explore): "Найди существующие docker-compose файлы"            [background]
→ Собрать → Написать docker-compose на основе исследования
```

### Сценарий 5: Параллельные независимые задачи

**Промпт:**
> "Одновременно: проверь @ref ссылки, подсчитай токены, и найди TODO в коде"

**Что сделает Claude:**
```
Task 1 (Bash): "python3 scripts/check-refs.py"        [background]
Task 2 (Bash): "scripts/validate-token-budget.sh"     [background]
Task 3 (Explore): "Найди все TODO/FIXME/HACK"         [background]
→ Три результата параллельно → Сводный отчёт
```

---

## Лучшие практики

### DO

| Практика | Почему |
|----------|--------|
| Read-heavy задачи параллельно | Нет конфликтов при чтении |
| Чёткие границы (каждый агент = своя директория) | Нет дублирования |
| Haiku для простых задач | Экономия 95% vs Opus |
| Opus только для координатора | Лучшая координация |
| `run_in_background: true` для независимых задач | Параллельность |
| Подробные промпты для субагентов | Субагент не видит контекст родителя |

### DON'T

| Ошибка | Последствие |
|--------|-------------|
| Несколько агентов пишут в один файл | Конфликты, потеря данных |
| Opus для всех субагентов | 10-20x дороже без пользы |
| Маленькие задачи через Task tool | Overhead > пользы |
| Размытые границы между агентами | Дублирование работы |
| Зависимые задачи параллельно | Нужен результат предыдущей |

---

## Управление в сессии

| Действие | Команда |
|----------|---------|
| Переключиться между агентами | `Shift+Up` / `Shift+Down` |
| Прервать агента | `Ctrl+C` |
| Посмотреть задачи | `/tasks` |
| Контекст/токены | `/context` |
| Статистика | `/stats` |

---

## Траблшутинг

### Субагенты не запускаются

**Причина:** Лимит токенов или API ключ
```bash
claude /usage        # Проверить лимит
claude /upgrade      # Увеличить план
```

### Дублирование работы

**Причина:** Нечёткие границы
**Решение:** В промпте указать: "Каждый агент работает ТОЛЬКО со своей директорией/файлом."

### Субагент не видит контекст

**Это by design.** Субагенты НЕ видят историю диалога. Передавайте весь нужный контекст в `prompt`.

### Медленная работа

**Причина:** Opus на субагентах или слишком много агентов
**Решение:** Проверить `CLAUDE_CODE_SUBAGENT_MODEL` в settings.json

---

## См. также

- [AGENTS.md](../../.claude/AGENTS.md) — Реестр агентов CodeFoundry
- [AGENT-CREATION-GUIDE.md](AGENT-CREATION-GUIDE.md) — Создание новых агентов
- [WORKFLOW-GUIDE.md](../WORKFLOW-GUIDE.md) — Полный справочник workflow

---

*← [Agents Index](index.md)*
