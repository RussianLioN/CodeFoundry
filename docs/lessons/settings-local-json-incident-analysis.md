# Expert Consilium v2.0 Analysis: settings.local.json Incident

**Date:** 2026-02-11
**Problem:** Claude Code –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—è–∑–Ω—è–µ—Ç settings.local.json –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏
**Approach:** Multi-round expert debate ‚Üí Lessons extraction ‚Üí Automation design

---

## üî¥ Problem Statement

**Initial Incident:**
```
–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ Claude Code:
  settings.local.json —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω:
  "Bash(file << 'EOF' ...)" ‚Äî heredoc –ª–æ–º–∞–µ—Ç JSON
```

**First Attempt (REJECTED):**
- –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–µ—Ç "NEVER edit settings.local.json" –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∫–æ–Ω—Å–∏–ª–∏—É–º —Ä–∞—Å–∫—Ä–∏—Ç–∏–∫–æ–≤–∞–ª –ø–æ–¥—Ö–æ–¥

---

## üé≠ Expert Consilium v2.0 Debates

### Domain Positions

| Domain | Initial Position | Final Position | Confidence Change |
|--------|-----------------|----------------|-------------------|
| **Infrastructure** | Manual control | Automated validation | +0.3 |
| **Delivery** | Pre-commit hooks | Full pipeline automation | +0.2 |
| **Quality** | Instructions change | System design fix | +0.4 |
| **AI** | Better prompts | Automated remediation | +0.3 |

---

## üìä Round 1: Domain Cross-Examination

### Infrastructure ‚Üí Delivery
**Challenge:** "–ó–∞–ø—Ä–µ—Ç—ã –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º"

**Delivery Response:** "–°–æ–≥–ª–∞—Å–µ–Ω. Pre-commit hooks ‚Äî —ç—Ç–æ better, –Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ù—É–∂–µ–Ω full pipeline."

**Result:** Delivery –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–ª –ø–æ–∑–∏—Ü–∏—é —Å hooks –Ω–∞ full automation.

---

### Quality ‚Üí AI
**Challenge:** "–ü—Ä–æ–º–ø—Ç—ã –Ω–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫–∏, –æ–Ω–∏ —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É—é—Ç –∏—Ö"

**AI Response:** "–í–µ—Ä–Ω–æ, –Ω–æ —Ö–æ—Ä–æ—à–∏–µ –ø—Ä–æ–º–ø—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç agent teams –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è"

**Result:** AI –ø—Ä–∏–∑–Ω–∞–ª –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ–º–ø—Ç–æ–≤, –ø–æ–¥—á–µ—Ä–∫–Ω—É–≤ need for automation.

---

## üìä Round 2: Adversarial Debates

### Docker Engineer vs CI/CD Architect

**Docker:** "–ó–∞–ø—Ä–µ—Ç –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –∫–∞–∫ –∑–∞–ø—Ä–µ—Ç –Ω–∞ docker commit. –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç."

**CI/CD:** "–ù—É–∂–µ–Ω automated validation –≤ pipeline, –Ω–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."

**Consensus:** Instructions ‚Üí Automated validation + pre-commit hooks.

---

### Unix Script Expert vs Prompt Engineer

**Unix:** "Heredoc ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞. –ü—Ä–æ–±–ª–µ–º–∞ –≤ auto-grant –ª–æ–≥–∏–∫–µ."

**Prompt:** "–ü—Ä–æ–º–ø—Ç—ã –º–æ–≥—É—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ heredoc –¥–ª—è file creation."

**Consensus:** Prevention (–ø—Ä–æ–º–ø—Ç—ã) + Remediation (auto-fix).

---

## üìä Round 3: Red Teaming

### Team "Instructions" vs Team "Automation"

**Team Instructions:** "–ò–∑–º–µ–Ω–∏—Ç—å CLAUDE.md —Å —è–≤–Ω—ã–º–∏ –∑–∞–ø—Ä–µ—Ç–∞–º–∏"

**Team Automation:** "–°–æ–∑–¥–∞—Ç—å validate-settings.py + pre-commit hook"

**Red Team Analysis:**
- ‚ùå Instructions: –ù–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç, —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É—é—Ç
- ‚úÖ Automation: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç + –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**Winner:** Team Automation (confidential: 0.95)

---

## üéØ Final Consensus

**RECOMMENDATION: AUTOMATED REMEDIATION** (confidence: 0.92)

**Rationale:**
1. **Prevention** ‚Üí –ü—Ä–æ–º–ø—Ç—ã –æ–±—ä—è—Å–Ω—è—é—Ç, –Ω–æ –Ω–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç
2. **Detection** ‚Üí Pre-commit hooks –ª–æ–≤—è—Ç –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
3. **Remediation** ‚Üí Auto-fix —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. **Recovery** ‚Üí BackupÊú∫Âà∂ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è

---

## üìö Extracted Lessons

### Lesson 1: The "Prohibition Anti-Pattern" ‚ö†Ô∏è

**Pattern:**
```
‚ùå WRONG: "NEVER edit X" in instructions
‚úÖ RIGHT: Automated validation + auto-fix
```

**Why it fails:**
- Instructions are read after errors occur
- Automated systems don't read instructions
- Humans ignore prohibitions under pressure

**Correct approach:**
```yaml
# –í–º–µ—Å—Ç–æ –∑–∞–ø—Ä–µ—Ç–∞ ‚Üí automated system
Prevention:  –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è agents (soft guidance)
Detection:   Pre-commit hooks (hard gate)
Remediation: Auto-fix scripts (self-healing)
Recovery:    Backup system (safety net)
```

---

### Lesson 2: Layered Defense > Single Point of Control üõ°Ô∏è

**Single layer (FAILED):**
```
Instruction: "NEVER edit settings.local.json"
```

**Layered defense (SUCCESS):**
```
Layer 1: Prompts           ‚Üí Educate agents
Layer 2: Pre-commit hook   ‚Üí Block invalid commits
Layer 3: Validation script ‚Üí Detect issues
Layer 4: Auto-fix script   ‚Üí Auto-remediate
Layer 5: Backup system     ‚Üí Recovery mechanism
```

**Principle:** –ö–∞–∂–¥—ã–π layer —Å–æ–∑–¥–∞—ë—Ç safety net –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ.

---

### Lesson 3: Automate the Workflow, Not Just the Fix üîß

**Wrong approach:**
```python
# Manual workflow
if settings_invalid:
    ask_user_to_fix()
```

**Right approach:**
```python
# Automated workflow
if settings_invalid:
    backup_settings()
    sanitize_settings()
    notify_user()
    # Continue working
```

**Principle:** Make the system self-healing, not just self-diagnosing.

---

### Lesson 4: Expert Consilium Value for Meta-Problems üí°

**Why 10 experts better than 1:**
- Docker Engineer —É–≤–∏–¥–µ–ª container-specific issues
- Unix Script Expert –ø–æ–Ω—è–ª heredoc –Ω–µ root cause
- CI/CD Architect –ø—Ä–µ–¥–ª–æ–∂–∏–ª pipeline integration
- GitOps Specialist –ø–æ–¥—á–µ—Ä–∫–Ω—É–ª state management
- SRE –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª automated remediation

**Cross-pollination:** Each expert challenged others' assumptions.

---

### Lesson 5: Error Pattern Recognition & Automation ü§ñ

**Pattern detected:**
```
settings.local.json polluted ‚Üí Error ‚Üí Manual fix ‚Üí Repeat
```

**Automation opportunity:**
```python
# Error frequency tracker
error_count = get_error_count("settings.invalid_json")

if error_count >= 3:
    # Automatically trigger remediation
    run_auto_fix()
    update_documentation()
    # Consider architectural fix
```

**Principle:** Third occurrence ‚Üí systemic issue, not user error.

---

## üîÑ Automation Design: Lesson-Learned System

### Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Error Occurrence                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Error Classification ‚îÇ
         ‚îÇ  - Type               ‚îÇ
         ‚îÇ  - Location           ‚îÇ
         ‚îÇ  - Context            ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Frequency Counter    ‚îÇ
         ‚îÇ  error_type: 2/3      ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ  Count >= 3? ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ NO                   ‚îÇ YES
         ‚ñº                       ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Log it  ‚îÇ         ‚îÇ LESSON LEARNED   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ 1. Auto-fix      ‚îÇ
                        ‚îÇ 2. Update docs   ‚îÇ
                        ‚îÇ 3. Add validator ‚îÇ
                        ‚îÇ 4. Notify user   ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Implementation

```python
# scripts/lesson-learned-tracker.py
"""
Automated lesson extraction from repeated errors.

When error occurs 3+ times:
1. Extract lesson automatically
2. Add to LESSONS.md
3. Create/update validation script
4. Update documentation
"""

import json
from datetime import datetime
from pathlib import Path
from collections import defaultdict

ERROR_LOG = ".tracking/error_log.json"
LESSONS_FILE = "LESSONS.md"
LESSON_THRESHOLD = 3


class LessonLearnedTracker:
    """Track errors and extract lessons from patterns."""

    def __init__(self):
        self.error_log = self._load_error_log()
        self.lessons = self._load_lessons()

    def log_error(self, error_type: str, location: str, context: dict):
        """Log an error occurrence."""
        key = f"{error_type}:{location}"

        if key not in self.error_log:
            self.error_log[key] = {
                "type": error_type,
                "location": location,
                "count": 0,
                "first_seen": datetime.now().isoformat(),
                "contexts": []
            }

        self.error_log[key]["count"] += 1
        self.error_log[key]["last_seen"] = datetime.now().isoformat()
        self.error_log[key]["contexts"].append(context)

        self._save_error_log()

        # Check if threshold reached
        if self.error_log[key]["count"] >= LESSON_THRESHOLD:
            self._extract_lesson(key)

    def _extract_lesson(self, error_key: str):
        """Extract and document lesson from repeated error."""
        error_info = self.error_log[error_key]

        lesson = {
            "error_type": error_info["type"],
            "location": error_info["location"],
            "occurrences": error_info["count"],
            "pattern": self._analyze_pattern(error_info["contexts"]),
            "lesson": self._generate_lesson(error_info),
            "prevention": self._generate_prevention(error_info),
            "created": datetime.now().isoformat()
        }

        self._add_to_lessons(lesson)
        self._create_validator(error_info)
        self._notify_user(lesson)

    def _analyze_pattern(self, contexts: list) -> str:
        """Analyze common pattern across occurrences."""
        # Extract commonalities
        return "Auto-detected pattern"

    def _generate_lesson(self, error_info: dict) -> str:
        """Generate lesson from error info."""
        return f"""### Lesson: {error_info['type']} in {error_info['location']}

**Pattern:** This error occurred {error_info['count']} times.

**Root Cause:** Auto-detected from contexts.

**Prevention:** See prevention section below."""

    def _generate_prevention(self, error_info: dict) -> list[str]:
        """Generate prevention strategies."""
        return [
            "Add validation script",
            "Update CLAUDE.md instructions",
            "Create pre-commit hook"
        ]

    def _add_to_lessons(self, lesson: dict):
        """Add lesson to LESSONS.md."""
        lessons_path = Path(LESSONS_FILE)

        if not lessons_path.exists():
            lessons_path.write_text("# Lessons Learned\n\n")

        content = lessons_path.read_text()
        content += f"\n## {lesson['error_type']}\n\n"
        content += f"**Occurrences:** {lesson['occurrences']}\n\n"
        content += f"**Pattern:** {lesson['pattern']}\n\n"
        content += f"**Lesson:** {lesson['lesson']}\n\n"
        content += f"**Prevention:**\n"
        for strategy in lesson['prevention']:
            content += f"- {strategy}\n"
        content += "\n---\n"

        lessons_path.write_text(content)

    def _create_validator(self, error_info: dict):
        """Create validation script for this error type."""
        # Auto-generate validator based on error pattern
        pass

    def _notify_user(self, lesson: dict):
        """Notify user about new lesson."""
        print(f"\nüéì LESSON LEARNED (occurrence #{lesson['occurrences']}):")
        print(f"   Type: {lesson['error_type']}")
        print(f"   Location: {lesson['location']}")
        print(f"   See: {LESSONS_FILE}\n")

    def _load_error_log(self) -> dict:
        """Load error log from file."""
        path = Path(ERROR_LOG)
        if path.exists():
            return json.loads(path.read_text())
        return {}

    def _save_error_log(self):
        """Save error log to file."""
        Path(ERROR_LOG).write_text(
            json.dumps(self.error_log, indent=2)
        )

    def _load_lessons(self) -> list:
        """Load existing lessons."""
        path = Path(LESSONS_FILE)
        if path.exists():
            return path.read_text()
        return ""


# Usage in quality gates or hooks
if __name__ == "__main__":
    tracker = LessonLearnedTracker()

    # Example: Log settings.json error
    tracker.log_error(
        error_type="invalid_json",
        location=".claude/settings.local.json",
        context={
            "file": "settings.local.json",
            "line": 66,
            "pattern": "heredoc in permissions"
        }
    )

    # On 3rd occurrence, lesson is auto-extracted
```

---

## üìã Action Items

### Immediate (P0)
- [x] Create validate-settings.py
- [x] Create sanitize-settings.py
- [x] Add pre-commit hook
- [x] Update .gitignore
- [x] Create settings.example.json

### Short-term (P1)
- [ ] Implement lesson-learned-tracker.py
- [ ] Create LESSONS.md template
- [ ] Add error tracking to quality gates
- [ ] Update CLAUDE.md with new approach

### Long-term (P2)
- [ ] Integrate with agent error reporting
- [ ] Auto-generate validators from patterns
- [ ] Create lesson recommendation engine
- [ ] Build lesson-search for agents

---

## üìñ References

- **Incident:** settings.local.json pollution (2026-02-11)
- **Solution:** Automated validation + remediation
- **Experts:** 10-domain consilium (3-round debate)
- **Outcome:** System design fix vs instruction fix

---

**Status:** ‚úÖ LESSONS EXTRACTED
**Next:** Implement lesson-learned-tracker.py
